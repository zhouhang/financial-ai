# å¯¹è´¦ç³»ç»Ÿä¼˜åŒ–æ€»ç»“

## ä¼˜åŒ–å†…å®¹

### 1. âœ… æ•°æ®æ¸…æ´— Schema çµæ´»åŒ–

#### æ—§è®¾è®¡çš„å±€é™æ€§
- åªæ”¯æŒå›ºå®šçš„å‡ ç§æ“ä½œï¼ˆé™¤ä»¥100ã€è®¢å•åˆå¹¶ï¼‰
- è§„åˆ™ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- ä¸å¤Ÿçµæ´»ï¼Œéš¾ä»¥æ‰©å±•

#### æ–°è®¾è®¡çš„ä¼˜åŠ¿
å…¨æ–°çš„è§„åˆ™ç»“æ„ï¼Œæ”¯æŒå››å¤§ç±»æ¸…æ´—è§„åˆ™ï¼š

#### ğŸ“‹ 1.1 å­—æ®µçº§åˆ«è½¬æ¢ (`field_transforms`)
æ”¯æŒå¤šç§æ“ä½œç±»å‹ï¼Œå¯æŒ‰æ–‡ä»¶æ¨¡å¼æ¡ä»¶æ‰§è¡Œï¼š

```json
"field_transforms": [
  {
    "field": "amount",
    "operation": "divide",
    "value": 100,
    "condition": "file_pattern: *finance*.csv",
    "description": "è´¢åŠ¡é‡‘é¢ä»åˆ†è½¬æ¢ä¸ºå…ƒ"
  },
  {
    "field": "amount",
    "operation": "round",
    "decimals": 2,
    "description": "é‡‘é¢ä¿ç•™2ä½å°æ•°"
  },
  {
    "field": "date",
    "operation": "format_date",
    "format": "%Y-%m-%d",
    "description": "æ—¥æœŸæ ¼å¼åŒ–"
  },
  {
    "field": "price",
    "operation": "expr",
    "expression": "row['amount'] * row['quantity']",
    "description": "è‡ªå®šä¹‰è¡¨è¾¾å¼è®¡ç®—"
  }
]
```

**æ”¯æŒçš„æ“ä½œç±»å‹ï¼š**
- `divide` - é™¤æ³•ï¼ˆå¦‚å•ä½è½¬æ¢ï¼‰
- `multiply` - ä¹˜æ³•
- `add` - åŠ æ³•
- `subtract` - å‡æ³•
- `round` - å››èˆäº”å…¥
- `abs` - ç»å¯¹å€¼
- `format_date` - æ—¥æœŸæ ¼å¼åŒ–
- `replace` - æ›¿æ¢å€¼
- `strip` - å»é™¤é¦–å°¾ç©ºæ ¼
- `upper` / `lower` - å¤§å°å†™è½¬æ¢
- `expr` - è‡ªå®šä¹‰è¡¨è¾¾å¼ï¼ˆæ”¯æŒä»»æ„ Python è¡¨è¾¾å¼ï¼‰

#### ğŸ“‹ 1.2 è¡Œçº§åˆ«è¿‡æ»¤ (`row_filters`)
è¿‡æ»¤ä¸éœ€è¦çš„æ•°æ®è¡Œï¼š

```json
"row_filters": [
  {
    "condition": "row['amount'] > 0",
    "description": "è¿‡æ»¤é‡‘é¢å°äºç­‰äº0çš„è®°å½•"
  },
  {
    "condition": "row.get('status', 'å·²å®Œæˆ') != 'å·²å–æ¶ˆ'",
    "description": "è¿‡æ»¤å·²å–æ¶ˆçš„è®¢å•"
  },
  {
    "condition": "row['customer'] != 'æµ‹è¯•å®¢æˆ·'",
    "description": "è¿‡æ»¤æµ‹è¯•æ•°æ®"
  }
]
```

#### ğŸ“‹ 1.3 èšåˆè§„åˆ™ (`aggregations`)
çµæ´»çš„åˆ†ç»„èšåˆé…ç½®ï¼š

```json
"aggregations": [
  {
    "group_by": ["order_id", "date"],
    "agg_fields": {
      "amount": "sum",
      "quantity": "sum",
      "status": "first",
      "price": "mean"
    },
    "description": "æŒ‰è®¢å•å·å’Œæ—¥æœŸèšåˆ"
  }
]
```

**æ”¯æŒçš„èšåˆå‡½æ•°ï¼š**
- `sum` - æ±‚å’Œ
- `mean` / `avg` - å¹³å‡å€¼
- `max` / `min` - æœ€å¤§å€¼/æœ€å°å€¼
- `count` - è®¡æ•°
- `first` / `last` - ç¬¬ä¸€ä¸ª/æœ€åä¸€ä¸ªå€¼

#### ğŸ“‹ 1.4 å…¨å±€è½¬æ¢ (`global_transforms`)
åº”ç”¨äºæ•´ä¸ªæ•°æ®é›†çš„æ“ä½œï¼š

```json
"global_transforms": [
  {
    "operation": "drop_duplicates",
    "subset": ["order_id"],
    "keep": "first"
  },
  {
    "operation": "sort",
    "by": ["date", "amount"],
    "ascending": [true, false]
  },
  {
    "operation": "drop_na",
    "subset": ["order_id", "amount"]
  },
  {
    "operation": "fill_na",
    "value": 0,
    "subset": ["amount"]
  }
]
```

**æ”¯æŒçš„å…¨å±€æ“ä½œï¼š**
- `drop_duplicates` - åˆ é™¤é‡å¤è®°å½•
- `sort` - æ’åº
- `drop_na` - åˆ é™¤ç©ºå€¼
- `fill_na` - å¡«å……ç©ºå€¼
- `reset_index` - é‡ç½®ç´¢å¼•

#### ğŸ“‹ 1.5 æ•°æ®æºçº§åˆ«é…ç½®
å¯ä»¥ä¸ºä¸åŒçš„æ•°æ®æºï¼ˆbusiness/financeï¼‰é…ç½®ä¸åŒçš„è§„åˆ™ï¼š

```json
"data_cleaning_rules": {
  "business": {
    "field_transforms": [...],
    "row_filters": [...],
    "aggregations": [...]
  },
  "finance": {
    "field_transforms": [...],
    "row_filters": [...],
    "aggregations": [...]
  },
  "global": {
    "global_transforms": [...]
  }
}
```

### 2. âœ… æµ‹è¯•æ•°æ®å¢å¼º

#### ç”Ÿæˆ 3000+ æ¡æµ‹è¯•æ•°æ®
- **ä¸šåŠ¡æµæ°´**: 3520 æ¡è®°å½•
  - æ­£å¸¸å®¢æˆ·: 2836 æ¡
  - æµ‹è¯•å®¢æˆ·: 684 æ¡
  - å·²å®Œæˆ: 3360 æ¡
  - å·²å–æ¶ˆ: 160 æ¡
- **è´¢åŠ¡æµæ°´**: 3300 æ¡è®°å½•

#### æ¨¡æ‹ŸçœŸå®å¯¹è´¦åœºæ™¯
- é‡‘é¢å·®å¼‚: çº¦ 155 ç¬”ï¼ˆ5%ï¼‰
- æ—¥æœŸå·®å¼‚: çº¦ 93 ç¬”ï¼ˆ3%ï¼‰
- ä¸šåŠ¡æœ‰è´¢åŠ¡æ— : çº¦ 100 ç¬”
- è´¢åŠ¡æœ‰ä¸šåŠ¡æ— : çº¦ 50 ç¬”
- é‡å¤è®¢å•: 10%-15%ï¼ˆæ¨¡æ‹Ÿåˆ†æ‰¹æ”¯ä»˜ï¼‰

### 3. âœ… å®Œæ•´æµ‹è¯•éªŒè¯

#### æµ‹è¯•ç»“æœ
```
å¯¹è´¦æ‘˜è¦:
  ä¸šåŠ¡è®°å½•æ€»æ•°: 3055ï¼ˆè¿‡æ»¤å’Œèšåˆåï¼‰
  è´¢åŠ¡è®°å½•æ€»æ•°: 3150ï¼ˆè¿‡æ»¤å’Œèšåˆåï¼‰
  åŒ¹é…è®°å½•æ•°:   0
  æœªåŒ¹é…è®°å½•æ•°: 7387

é—®é¢˜è¯¦æƒ…ï¼ˆå…± 7967 ä¸ªé—®é¢˜ï¼‰:
  missing_in_finance: 93 ä¸ª
  amount_mismatch: 4760 ä¸ª
  date_mismatch: 2346 ä¸ª
  skipped: 580 ä¸ª
  missing_in_business: 188 ä¸ª
```

#### æ•°æ®æ¸…æ´—æµç¨‹æ‰§è¡Œ
```
âœ… åº”ç”¨è¿‡æ»¤è§„åˆ™: è¿‡æ»¤å·²å–æ¶ˆçš„è®¢å•, å‰©ä½™ 3360 æ¡è®°å½•
âœ… åº”ç”¨å­—æ®µè½¬æ¢: é‡‘é¢ä¿ç•™2ä½å°æ•°
âœ… åº”ç”¨å­—æ®µè½¬æ¢: æ—¥æœŸæ ¼å¼åŒ–
âœ… åº”ç”¨å­—æ®µè½¬æ¢: è®¢å•å·å»é™¤é¦–å°¾ç©ºæ ¼
âœ… åº”ç”¨èšåˆ: æŒ‰è®¢å•å·èšåˆï¼Œé‡‘é¢æ±‚å’Œ, ç»“æœ 3055 æ¡è®°å½•
âœ… åˆ é™¤é‡å¤è®°å½•ï¼Œå‰©ä½™ 3055 æ¡

âœ… åº”ç”¨è¿‡æ»¤è§„åˆ™: è¿‡æ»¤é‡‘é¢å°äºç­‰äº0çš„è®°å½•, å‰©ä½™ 3300 æ¡è®°å½•
âœ… åº”ç”¨å­—æ®µè½¬æ¢: è´¢åŠ¡é‡‘é¢ä»åˆ†è½¬æ¢ä¸ºå…ƒ
âœ… åº”ç”¨å­—æ®µè½¬æ¢: é‡‘é¢å–ç»å¯¹å€¼
âœ… åº”ç”¨å­—æ®µè½¬æ¢: æ—¥æœŸæ ¼å¼åŒ–
âœ… åº”ç”¨èšåˆ: æŒ‰è®¢å•å·èšåˆï¼Œé‡‘é¢æ±‚å’Œ, ç»“æœ 3150 æ¡è®°å½•
âœ… åˆ é™¤ç©ºå€¼ï¼Œå‰©ä½™ 3150 æ¡
```

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•çš„é‡‘é¢å•ä½è½¬æ¢

```json
{
  "data_cleaning_rules": {
    "finance": {
      "field_transforms": [
        {
          "field": "amount",
          "operation": "divide",
          "value": 100,
          "description": "åˆ†è½¬å…ƒ"
        }
      ]
    }
  }
}
```

### ç¤ºä¾‹ 2: å¤æ‚çš„å¤šæ­¥éª¤æ¸…æ´—

```json
{
  "data_cleaning_rules": {
    "business": {
      "row_filters": [
        {
          "condition": "row['status'] == 'å·²å®Œæˆ'",
          "description": "åªä¿ç•™å·²å®Œæˆè®¢å•"
        },
        {
          "condition": "row['amount'] > 0",
          "description": "é‡‘é¢å¿…é¡»å¤§äº0"
        }
      ],
      "field_transforms": [
        {
          "field": "amount",
          "operation": "round",
          "decimals": 2
        },
        {
          "field": "total_price",
          "operation": "expr",
          "expression": "row['amount'] * row['quantity']"
        }
      ],
      "aggregations": [
        {
          "group_by": "order_id",
          "agg_fields": {
            "amount": "sum",
            "quantity": "sum"
          }
        }
      ],
      "global_transforms": [
        {
          "operation": "drop_na",
          "subset": ["order_id"]
        },
        {
          "operation": "sort",
          "by": "date"
        }
      ]
    }
  }
}
```

### ç¤ºä¾‹ 3: æŒ‰æ–‡ä»¶æ¨¡å¼åº”ç”¨ä¸åŒè§„åˆ™

```json
{
  "data_cleaning_rules": {
    "finance": {
      "field_transforms": [
        {
          "field": "amount",
          "operation": "divide",
          "value": 100,
          "condition": "file_pattern: *alipay*.csv",
          "description": "æ”¯ä»˜å®æ•°æ®å•ä½è½¬æ¢"
        },
        {
          "field": "amount",
          "operation": "multiply",
          "value": 1.06,
          "condition": "file_pattern: *bank*.csv",
          "description": "é“¶è¡Œæ•°æ®åŠ æ‰‹ç»­è´¹"
        }
      ]
    }
  }
}
```

## ä¼˜åŠ¿æ€»ç»“

### ğŸ¯ çµæ´»æ€§
- **æ— éœ€æ”¹ä»£ç **ï¼šæ‰€æœ‰è§„åˆ™é€šè¿‡ schema é…ç½®
- **ç»„åˆä½¿ç”¨**ï¼šå¯ä»¥ä»»æ„ç»„åˆå¤šç§è§„åˆ™
- **æ¡ä»¶æ‰§è¡Œ**ï¼šæ”¯æŒåŸºäºæ–‡ä»¶æ¨¡å¼çš„æ¡ä»¶è§„åˆ™

### ğŸ¯ å¯æ‰©å±•æ€§
- **è‡ªå®šä¹‰è¡¨è¾¾å¼**ï¼šæ”¯æŒä»»æ„ Python è¡¨è¾¾å¼
- **å¤šç§æ“ä½œ**ï¼šæ¶µç›–å¸¸è§çš„æ•°æ®æ¸…æ´—éœ€æ±‚
- **åˆ†å±‚é…ç½®**ï¼šæ•°æ®æºçº§åˆ« + å…¨å±€çº§åˆ«

### ğŸ¯ å¯ç»´æŠ¤æ€§
- **æ¸…æ™°çš„ç»“æ„**ï¼šè§„åˆ™åˆ†ç±»æ˜ç¡®
- **è¯¦ç»†çš„è¯´æ˜**ï¼šæ¯ä¸ªè§„åˆ™éƒ½æœ‰ description
- **æ˜“äºè°ƒè¯•**ï¼šæ¯æ­¥æ“ä½œéƒ½æœ‰æ—¥å¿—è¾“å‡º

### ğŸ¯ æ€§èƒ½
- **é«˜æ•ˆæ‰§è¡Œ**ï¼šåŸºäº pandas çš„å‘é‡åŒ–æ“ä½œ
- **3000+ æ•°æ®**ï¼šç§’çº§å®Œæˆå¯¹è´¦

## æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- `mcp_server/data_cleaner.py` - æ•°æ®æ¸…æ´—å™¨ï¼ˆå·²ä¼˜åŒ–ï¼‰
- `schemas/example_schema.json` - ç¤ºä¾‹ schemaï¼ˆv2.0ï¼‰

### æµ‹è¯•æ–‡ä»¶
- `generate_test_data.py` - æµ‹è¯•æ•°æ®ç”Ÿæˆè„šæœ¬
- `test_reconciliation.py` - å¯¹è´¦åŠŸèƒ½æµ‹è¯•è„šæœ¬
- `test_data/business_flow.csv` - ä¸šåŠ¡æµæ°´ï¼ˆ3520 æ¡ï¼‰
- `test_data/ads_finance_d_inc_channel_details_20250101.csv` - è´¢åŠ¡æµæ°´ï¼ˆ3300 æ¡ï¼‰
- `results/test_result.json` - æµ‹è¯•ç»“æœ

### æ–‡æ¡£
- `OPTIMIZATION_SUMMARY.md` - æœ¬æ–‡æ¡£
- `README.md` - é¡¹ç›®æ–‡æ¡£ï¼ˆå·²æ›´æ–°ï¼‰

## ä¸‹ä¸€æ­¥

æœåŠ¡å™¨å·²æ›´æ–°å¹¶è¿è¡Œåœ¨ `http://localhost:3335`ï¼Œå¯ä»¥åœ¨ Dify ä¸­è¿›è¡Œæµ‹è¯•ï¼š

1. é…ç½® MCP æœåŠ¡å™¨åœ°å€: `http://localhost:3335/sse`
2. ä½¿ç”¨ `file_upload` å·¥å…·ä¸Šä¼  CSV æ–‡ä»¶
3. ä½¿ç”¨ `reconciliation_start` å·¥å…·å¼€å§‹å¯¹è´¦
4. ä½¿ç”¨ `reconciliation_result` å·¥å…·è·å–ç»“æœ

æ‰€æœ‰åŠŸèƒ½å·²ç»è¿‡å®Œæ•´æµ‹è¯•éªŒè¯ï¼âœ…

