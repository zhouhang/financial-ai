{
  // Schema 版本号，用于标识对账规则的版本
  "version": "1.0",
  
  // 对账类型描述，说明该 schema 的用途
  "description": "直销对账 - 供应商充值账单 vs 财务BI对账流水",
  
  // 数据源配置，定义业务和财务数据的文件匹配规则和字段映射
  "data_sources": {
    // 财务数据源配置
    "finance": {
      // 文件匹配模式，支持通配符和正则表达式，用于识别财务数据文件
      "file_pattern": ["ads_finance_d_inc_channel_details*.csv", "ads_finance_d_inc_channel_details*.xlsx"],
      
      // 字段角色映射，将财务文件中的原始字段名映射到统一的标准字段名
      "field_roles": {
        // 订单ID字段，映射到财务文件中的"sup订单号"列
        "order_id": "sup订单号",
        // 金额字段，映射到财务文件中的"发生-"列
        "amount": "发生-",
        // 日期字段，映射到财务文件中的"完成时间"列
        "date": "完成时间"
      }
    },
    // 业务数据源配置
    "business": {
      // 文件匹配模式，支持通配符和正则表达式，用于识别业务数据文件
      "file_pattern": ["*对账流水*.csv", "*对账流水*.xlsx", "[0-9]{13}*.csv", "[0-9]{13}*.xlsx"],
      
      // 字段角色映射，将业务文件中的原始字段名映射到统一的标准字段名（支持多个候选字段名）
      "field_roles": {
        // 订单ID字段，按优先级尝试匹配：roc_oid、sp订单号
        "order_id": ["roc_oid", "sp订单号"],
        // 金额字段，按优先级尝试匹配：product_price、销售额
        "amount": ["product_price", "销售额"],
        // 日期字段，按优先级尝试匹配：statis_date、订单时间
        "date": ["statis_date", "订单时间"],
        // 状态字段，按优先级尝试匹配：result、状态
        "status": ["result", "状态"],
        // 订单日期字段，按优先级尝试匹配：order_time、订单日期
        "order_date": ["order_time", "订单日期"]
      }
    }
  },
  
  // 关键字段角色，用于对账时匹配业务和财务记录的主键字段
  "key_field_role": "order_id",
  
  // 容差配置，定义对账时的容差范围
  "tolerance": {
    // 日期格式，用于日期比较时的格式化
    "date_format": "%Y-%m-%d"
    // 注意：amount_diff_max 为可选配置，如果未配置则默认为 0.0
  },
  
  // 数据清洗规则，定义对原始数据进行清洗、转换、聚合的规则
  "data_cleaning_rules": {
    // 财务数据清洗规则
    "finance": {
      // 字段转换规则，对单个字段进行转换操作
      "field_transforms": [
        {
          // 要转换的字段名
          "field": "amount",
          // 转换操作类型：abs（取绝对值）、divide（除法）、multiply（乘法）、round（四舍五入）等
          "operation": "abs",
          // 规则描述
          "description": "金额取绝对值（发生-字段可能为负）"
        },
        {
          "field": "amount",
          "operation": "round",
          // 保留小数位数
          "decimals": 2,
          "description": "金额保留2位小数"
        },
        {
          "field": "order_id",
          // strip：去除首尾空格
          "operation": "strip",
          "description": "订单号去除首尾空格"
        },
        {
          "field": "order_id",
          // expr：自定义表达式转换
          "operation": "expr",
          // Python 表达式，row 表示当前行数据，pd 表示 pandas
          "expression": "str(row.get('order_id', '')).lstrip(\"'\") if pd.notna(row.get('order_id', '')) else row.get('order_id', '')",
          "description": "订单号去掉前面的单引号"
        },
        {
          "field": "order_id",
          "operation": "expr",
          "expression": "str(row.get('order_id', ''))[:21] if pd.notna(row.get('order_id', '')) and len(str(row.get('order_id', ''))) > 21 else str(row.get('order_id', ''))",
          "description": "订单号只取前21位，统一为21位与业务订单号匹配"
        }
      ],
      // 行过滤规则，过滤掉不符合条件的行
      "row_filters": [
        {
          // 过滤条件，Python 表达式，返回 True 的行保留
          "condition": "str(row.get('order_id', '')).startswith('104') or str(row.get('order_id', '')).startswith(\"'104\")",
          "description": "只保留104开头的订单号（支持带单引号）"
        }
      ],
      // 聚合规则，对相同 key_field_role 的记录进行聚合
      "aggregations": [
        {
          // 分组字段，通常是 order_id
          "group_by": "order_id",
          // 聚合字段配置，key 为字段名，value 为聚合函数（sum、first、last、max、min 等）
          "agg_fields": {
            "amount": "sum",
            "date": "first"
          },
          "description": "按sup订单号合并，发生-字段求和"
        }
      ],
      // 全局转换规则，对整个 DataFrame 进行操作
      "global_transforms": [
        {
          // 操作类型：drop_na（删除空值）、drop_duplicates（去重）、sort（排序）等
          "operation": "drop_na",
          // 要检查的字段列表
          "subset": ["order_id", "amount"],
          "description": "删除关键字段为空的记录"
        }
      ]
    },
    // 业务数据清洗规则
    "business": {
      "field_transforms": [
        {
          "field": "amount",
          "operation": "divide",
          // 除数
          "value": 100,
          // 可选：条件表达式，只有满足条件时才执行转换
          "condition": "pd.to_numeric(row.get('amount', 0), errors='coerce') > 100",
          "description": "金额单位转换：分转元（仅当金额>100时执行）"
        },
        {
          "field": "amount",
          "operation": "round",
          "decimals": 2,
          "description": "金额保留2位小数"
        },
        {
          "field": "order_id",
          "operation": "strip",
          "description": "订单号去除首尾空格"
        },
        {
          "field": "order_id",
          "operation": "expr",
          "expression": "str(row.get('order_id', '')).lstrip(\"'\") if pd.notna(row.get('order_id', '')) else row.get('order_id', '')",
          "description": "订单号去掉前面的单引号"
        },
        {
          "field": "order_id",
          "operation": "expr",
          "expression": "str(row.get('order_id', ''))[:21] if pd.notna(row.get('order_id', '')) and len(str(row.get('order_id', ''))) > 21 else str(row.get('order_id', ''))",
          "description": "订单号只取前21位，统一为21位与财务订单号匹配"
        }
      ],
      "row_filters": [
        {
          "condition": "str(row.get('order_id', '')).strip().startswith('104')",
          "description": "只保留104开头的订单号"
        }
      ],
      "aggregations": [
        {
          "group_by": "order_id",
          "agg_fields": {
            "amount": "sum",
            "date": "first",
            "status": "first",
            "order_date": "first"
          },
          "description": "按roc_oid或sp订单号合并，product_price字段求和"
        }
      ],
      "global_transforms": [
        {
          "operation": "drop_na",
          "subset": ["order_id"],
          "description": "删除订单号为空的记录"
        }
      ]
    },
    // 全局清洗规则，应用于所有数据源
    "global": {
      "global_transforms": [
        {
          "operation": "drop_duplicates",
          "subset": ["order_id"],
          // 保留第一条还是最后一条
          "keep": "first",
          "description": "全局去重，保留第一条"
        }
      ]
    }
  },
  
  // 自定义验证规则，定义对账时的验证逻辑（按顺序执行，一旦满足条件就停止）
  "custom_validations": [
    {
      // 规则名称
      "name": "missing_in_business",
      // 条件表达式，Python 表达式，返回 True 时触发该规则
      // 可用变量：biz（业务记录字典）、fin（财务记录字典）、biz_exists（业务记录是否存在）、fin_exists（财务记录是否存在）
      "condition_expr": "fin_exists and not biz_exists",
      // 问题类型，用于标识对账问题的类型
      "issue_type": "missing_in_business",
      // 详细信息模板，支持占位符：{biz_file}、{fin_file}、{biz[字段名]}、{fin[字段名]}、{amount_diff_formatted}、{amount_diff_max} 等
      "detail_template": "{fin_file}存在，{biz_file}无此订单记录"
    },
    {
      "name": "missing_in_finance",
      "condition_expr": "biz_exists and not fin_exists",
      "issue_type": "missing_in_finance",
      "detail_template": "{biz_file}存在，{fin_file}无此订单记录"
    },
    {
      "name": "amount_mismatch",
      // 金额不匹配：两边都存在，且金额差值超过容差
      "condition_expr": "biz_exists and fin_exists and 'amount' in biz and 'amount' in fin and abs(float(biz.get('amount', 0)) - float(fin.get('amount', 0))) > amount_diff_max",
      "issue_type": "amount_mismatch",
      "detail_template": "{biz_file}金额 {biz[amount]} vs {fin_file}金额 {fin[amount]}，差额 {amount_diff_formatted} 超出容差 {amount_diff_max}"
    },
    {
      "name": "date_mismatch",
      // 日期不匹配：两边都存在，且日期不一致
      "condition_expr": "biz_exists and fin_exists and 'date' in biz and 'date' in fin and str(biz.get('date', '')) and str(fin.get('date', '')) and (lambda bd, fd: (lambda dt1, dt2: pd.notna(dt1) and pd.notna(dt2) and dt1.strftime('%Y-%m-%d') != dt2.strftime('%Y-%m-%d'))(pd.to_datetime(bd, errors='coerce'), pd.to_datetime(fd, errors='coerce')))(str(biz.get('date', '')), str(fin.get('date', '')))",
      "issue_type": "date_mismatch",
      "detail_template": "{biz_file}交易时间 {biz[date]} 与{fin_file}记录 {fin[date]} 不一致"
    },
    {
      "name": "order_status_mismatch",
      // 订单状态不匹配：业务订单状态不是 success 或 成功
      "condition_expr": "biz_exists and str(biz.get('status', '')).lower() not in ['success', '成功']",
      "issue_type": "order_status_mismatch",
      "detail_template": "订单状态不一致：状态为 {biz[status]}，不是 success 或 成功"
    },
    {
      "name": "order_status_not_over",
      // 订单状态未完成：状态为"充值中"且超过7天
      "condition_expr": "biz_exists and biz.get('status', '') == '充值中' and (pd.Timestamp.now() - pd.to_datetime(biz.get('order_date', pd.Timestamp.now()))).days > 7",
      "issue_type": "order_status_not_over",
      "detail_template": "订单状态未完成：订单状态为充值中，且已超过7天（订单日期：{biz[order_date]}）"
    }
  ]
}
