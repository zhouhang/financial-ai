{
  "version": "3.0",
  "schema_type": "step_based",
  "metadata": {
    "project_name": "货币资金数据整理",
    "author": "审计部",
    "created_at": "2026-01-10",
    "description": "从福擎科目余额表中抽取银行存款数据并填入审计底稿"
  },

  "template_config": {
    "template_file": "01 审计底稿-模板.xlsx",
    "output_filename_pattern": "货币资金审计底稿_{timestamp}.xlsx"
  },

  "processing_steps": [
    {
      "step_id": "step_1",
      "step_name": "读取本期科目余额表并写入模板",
      "step_type": "extract_and_write",
      "description": "从福擎-科目余额表 本期2025 中提取银行存款数据，写入审计底稿模板",
      "depends_on": [],
      "enabled": true,

      "data_source": {
        "source_type": "uploaded_file",
        "file_pattern": "*科目余额表*本期*2025*.xlsx",
        "extraction_rules": {
          "multi_index_header": [0, 1],
          "columns_mapping": {
            "科目名称": "account_name",
            "核算项目": "project_item"
          }
        },
        "conditional_extractions": {
          "condition_id": "bank_deposit_current_period",
          "name": "本期银行存款-*筛选",
          "description": "科目名称匹配'银行存款_*'格式（只匹配'银行存款_xx'，不匹配'银行存款_xx_yy'）且核算项目不为空",
          "condition": {
            "type": "and",
            "conditions": [
              {
                "type": "column_matches",
                "column_header": "account_name",
                "regex_pattern": "^银行存款_[^_]+$",
                "match_type": "regex"
              },
              {
                "type": "column_empty",
                "column_header": "project_item",
                "empty_check": false
              }
            ]
          },
          "extraction": {
            "target_fields": [
              "account_name",
              "project_item",
              {
                "field": "期初余额",
                "sub_field": "借方",
                "output_field": "opening_balance_debit"
              },
              {
                "field": "本期发生额",
                "sub_field": "借方",
                "output_field": "current_period_debit"
              },
              {
                "field": "本期发生额",
                "sub_field": "贷方",
                "output_field": "current_period_credit"
              }
            ],
            "output_type": "table"
          }
        },
        "validation_rules": [
          {
            "rule": "not_null",
            "fields": ["account_name", "project_item"],
            "error_message": "科目名称和核算项目不能为空"
          }
        ]
      },

      "template_action": {
        "action_type": "write_table",
        "target": {
          "sheet": "货币资金",
          "start_cell": "B9",
          "header_mapping": {
            "account_name": "B",
            "project_item": "C",
            "opening_balance_debit": "D",
            "current_period_debit": "E",
            "current_period_credit": "F"
          }
        }
      },

      "output_variables": {
        "current_period_data": {
          "description": "本期银行存款数据，供上期数据匹配使用",
          "fields": ["account_name", "project_item"]
        }
      }
    },

    {
      "step_id": "step_2",
      "step_name": "读取模板并匹配上期科目余额表",
      "step_type": "read_template_and_match",
      "description": "读取模板中的本期数据，作为条件匹配上期科目余额表的贷方金额",
      "depends_on": ["step_1"],
      "enabled": true,

      "template_reference": {
        "sheet": "货币资金",
        "range": "B9:C100",
        "columns_mapping": {
          "B": "account_name",
          "C": "project_item"
        },
        "read_until_empty": true
      },

      "data_source": {
        "source_type": "uploaded_file",
        "file_pattern": "*科目余额表*上期*2024*.xlsx",
        "extraction_rules": {
          "multi_index_header": [0, 1],
          "columns_mapping": {
            "科目名称": "account_name",
            "核算项目": "project_item"
          }
        },
        "conditional_extractions": {
          "condition_id": "bank_deposit_prior_period",
          "name": "上期银行存款-*筛选",
          "description": "科目名称匹配'银行存款_*'格式（只匹配'银行存款_xx'，不匹配'银行存款_xx_yy'）且核算项目不为空",
          "condition": {
            "type": "and",
            "conditions": [
              {
                "type": "column_matches",
                "column_header": "account_name",
                "regex_pattern": "^银行存款_[^_]+$",
                "match_type": "regex"
              },
              {
                "type": "column_empty",
                "column_header": "project_item",
                "empty_check": false
              }
            ]
          },
          "extraction": {
            "target_fields": [
              "account_name",
              "project_item",
              {
                "field": "本期发生额",
                "sub_field": "贷方",
                "output_field": "prior_period_credit"
              }
            ],
            "output_type": "table"
          },
          "match_with_template": {
            "template_fields": ["account_name", "project_item"],
            "data_fields": ["account_name", "project_item"],
            "match_type": "inner_join"
          }
        },
        "validation_rules": [
          {
            "rule": "not_null",
            "fields": ["account_name", "project_item"],
            "error_message": "科目名称和核算项目不能为空"
          }
        ]
      },

      "template_action": {
        "action_type": "write_matched",
        "target": {
          "sheet": "货币资金",
          "match_by": {
            "template_columns": ["B", "C"],
            "data_fields": ["account_name", "project_item"]
          },
          "write_columns": {
            "prior_period_credit": "H"
          }
        }
      }
    }
  ],

  "workflow_controls": {
    "execution_order": "sequential",
    "error_handling": {
      "on_extraction_error": "skip_and_log",
      "on_calculation_error": "use_default:0",
      "max_errors": 10
    },
    "logging": {
      "level": "INFO",
      "output_file": "monetary_funds_processing_log_{timestamp}.txt"
    }
  }
}
